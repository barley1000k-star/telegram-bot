import re
import asyncio
from datetime import datetime
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters

TOKEN = "7785638760:AAGycp8N6bGilag3ZxKgLj9prHut7X3vAag"

stats = {}

pattern = re.compile(r'^(\d+)—Å, –æ—Ç–º–µ—Ç–∏–ª$', re.IGNORECASE)

async def handle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    user = update.effective_user.first_name
    chat = update.effective_chat.id

    context.application.bot_data.setdefault("chat_id", chat)

    match = pattern.match(text)
    if not match:
        return

    value = int(match.group(1))

    if user not in stats:
        stats[user] = {"count":0, "sum":0}

    stats[user]["count"] += 1
    stats[user]["sum"] += value


async def report(app):
    while True:
        now = datetime.now()

        if now.hour == 0 and now.minute == 0:
            if "chat_id" in app.bot_data:
                msg = "üìä –ò—Ç–æ–≥–∏ –¥–Ω—è:\n"
                total = 0

                for u in stats:
                    msg += f"{u}: —Å–æ–æ–±—â–µ–Ω–∏–π {stats[u]['count']} —Å—É–º–º–∞ {stats[u]['sum']}\n"
                    total += stats[u]['sum']

                msg += f"\n–û–±—â–∞—è —Å—É–º–º–∞: {total}"

                await app.bot.send_message(app.bot_data["chat_id"], msg)

            stats.clear()
            await asyncio.sleep(60)

        await asyncio.sleep(20)


async def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT, handle))
    app.create_task(report(app))
    await app.run_polling()


asyncio.run(main())